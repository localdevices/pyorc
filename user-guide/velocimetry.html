
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Velocimetry &#8212; pyorc 0.3.3 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../_static/styles/bootstrap.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=796348d33e8b1d947c94" rel="stylesheet">
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94">
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user-guide/velocimetry';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Transect" href="transect.html" />
    <link rel="prev" title="Frames" href="frames/frames.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>

  
  <input type="checkbox" class="sidebar-toggle" name="__primary" id="__primary">
  <label class="overlay overlay-primary" for="__primary"></label>

  
  <input type="checkbox" class="sidebar-toggle" name="__secondary" id="__secondary">
  <label class="overlay overlay-secondary" for="__secondary"></label>

  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
      
<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  </div>

  
  <nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
      <span class="fa-solid fa-bars"></span>
  </label>
  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../index.html">

  
  
  
  
  
  
  

  
  
    <p class="title logo__title">pyorc 0.3.3 documentation</p>
  
</a>
    
  </div>

  
  <div class="col-lg-9 navbar-header-items">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../intro.html">
                        Introduction
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../installation.html">
                        Installation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../quickstart.html">
                        Quick start
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api.html">
                        API reference
                      </a>
                    </li>
                
    </ul>
</nav>
      </div>
      
    </div>

    <div id="navbar-end">
      
        <div class="navbar-end-item navbar-persistent--container">
          
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
        </div>
      
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>


  
  
    <div class="navbar-persistent--mobile">
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
    </div>
  

  
  <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
  </label>
  

</div>
  </nav>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        
  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../intro.html">
                        Introduction
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../installation.html">
                        Installation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../quickstart.html">
                        Quick start
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api.html">
                        API reference
                      </a>
                    </li>
                
    </ul>
</nav>
      </div>
      
      </div>
    

    
    
    <div class="sidebar-header-items__end">
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
    
  </div>

  
  <div class="sidebar-start-items sidebar-primary__section">
    <div class="sidebar-start-items__item"><nav class="bd-links" id="bd-docs-nav" aria-label="Section navigation">
  <p class="bd-links__title" role="heading" aria-level="1">
    Section Navigation
  </p>
  <div class="bd-toc-item navbar-nav">
    <p aria-level="2" class="caption" role="heading"><span class="caption-text">Table of Content</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="video.html">Videos</a></li>
<li class="toctree-l1"><a class="reference internal" href="camera_config/index.html">Camera configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="frames/frames.html">Frames</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Velocimetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="transect.html">Transects</a></li>
</ul>

  </div>
</nav>
    </div>
  </div>
  

  
  <div class="sidebar-end-items sidebar-primary__section">
    <div class="sidebar-end-items__item">
    </div>
  </div>

  
  <div id="rtd-footer-container"></div>

      </div>
      <main id="main-content" class="bd-main">
        
        
        <div class="bd-content">
          <div class="bd-article-container">
            
            <div class="bd-header-article">
                
            </div>
            
            
            <article class="bd-article" role="main">
              
  <section id="velocimetry">
<span id="velocimetry-ug"></span><h1>Velocimetry<a class="headerlink" href="#velocimetry" title="Permalink to this heading">#</a></h1>
<p>Estimating surface velocity is one of the core methods of <em>pyorc</em>. Typically surface velocity is derived from a set
of frames, by analyzing frame to frame movements in time. This can be done with several methods. <em>pyorc</em> currently
has implemented one of these methods called “Particle Image Velocimetry”</p>
<section id="particle-image-velocimetry">
<h2>Particle Image Velocimetry<a class="headerlink" href="#particle-image-velocimetry" title="Permalink to this heading">#</a></h2>
<p>Particle Image Velocimetry uses cross-correlation methods to estimate the most likely position of an observed pattern
from frame to frame. Therefore there is no interdependency over more than 2 frames. To observe patterns, the total area
of interest is subdivided into small blocks of pixels with overlap, also called “interrogation windows”. Currently the
overlap is fixed in <em>pyorc</em> on 50% of each block. Say that you have reprojected your data to a 0.02 m resolution with
<code class="docutils literal notranslate"><span class="pre">frames.project()</span></code>, and you select an interrogation window of 20 pixels, then each interrogation window will be
0.02 * 20 = 0.4 m in size in both x- and y-direction. The next window will share 10 pixels with its neighbouring window
and hence a velocity will be resolved for each 0.2 x 0.2 meters.</p>
<p>The only direct requirement for calculating velocimetry is that you have:</p>
<ul class="simple">
<li><p>opened a <a class="reference internal" href="camera_config/index.html#camera-config-ug"><span class="std std-ref">Camera configurations</span></a> video with <code class="docutils literal notranslate"><span class="pre">pyorc.Video</span></code> (e.g. to an object called <code class="docutils literal notranslate"><span class="pre">video</span></code>) using a video file and a camera configuration;</p></li>
<li><p>retrieved frames from it using <code class="docutils literal notranslate"><span class="pre">video.get_frames</span></code> (e.g. into a <code class="docutils literal notranslate"><span class="pre">DataArray</span></code> called <code class="docutils literal notranslate"><span class="pre">frames</span></code>;</p></li>
<li><p>orthorectified the frames using <code class="docutils literal notranslate"><span class="pre">frames.project</span></code> (e.g. into <code class="docutils literal notranslate"><span class="pre">frames_proj</span></code>.</p></li>
</ul>
<p>Naturally, before orthorectification you may decide to apply one or several preprocessing methods as described in
<a class="reference internal" href="frames/index.html#frames-man"><span class="std std-ref">Frames</span></a> to improve the visibility of tracers. We highly recommend that in many cases, and you can follow our
examples section to see how you may apply these.</p>
<p>Getting surface velocity from the orthoprojected set of frames stored in object <code class="docutils literal notranslate"><span class="pre">frames_proj</span></code> is as easy as calling</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">piv</span> <span class="o">=</span> <span class="n">frames_proj</span><span class="o">.</span><span class="n">get_piv</span><span class="p">()</span>
</pre></div>
</div>
<p>The size of the interrogation window can already be set in the camera configuration, as shown in <a class="reference internal" href="camera_config/index.html#camera-config-ug"><span class="std std-ref">Camera configurations</span></a>.
However, you may also provide a different window size on the fly using the keyword <code class="docutils literal notranslate"><span class="pre">window_size</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore the window size in the camera config and set this to 10 pixels</span>
<span class="n">piv</span> <span class="o">=</span> <span class="n">frame_proj</span><span class="o">.</span><span class="n">get_piv</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="interrogating-and-storing-piv-results">
<h2>Interrogating and storing PIV results<a class="headerlink" href="#interrogating-and-storing-piv-results" title="Permalink to this heading">#</a></h2>
<p>The object <code class="docutils literal notranslate"><span class="pre">piv</span></code> is a normal <code class="docutils literal notranslate"><span class="pre">xarray.Dataset</span></code> object. Therefore, you can use any <code class="docutils literal notranslate"><span class="pre">xarray</span></code> functionality to
interrogate the data. An important functionality for instance that you may require, is to reduce the data to a
time-averaged mean or one or more quantiles such as a median. This is important for instance when you want to plot
results in a spatial view:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># derive the mean over time</span>
<span class="n">piv_mean</span> <span class="o">=</span> <span class="n">piv</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
<span class="c1"># derive the median</span>
<span class="n">piv_median</span> <span class="o">=</span> <span class="n">piv</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>If you apply such reducers, <code class="docutils literal notranslate"><span class="pre">xarray</span></code> can no longer guarantee that the metadata attributes of your data variables remain
valid. Therefore, you normally loose metadata, important to for instance reproject data onto the camera perspective.
Therefore we highly recommend to apply such reducers with <code class="docutils literal notranslate"><span class="pre">keep_attrs=True</span></code> to prevent that important attributes
get lost in the process.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># derive the mean over time, while keeping the attributes in place</span>
<span class="n">piv_mean</span> <span class="o">=</span> <span class="n">piv</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># derive the median, while keeping the attributes in place</span>
<span class="n">piv_median</span> <span class="o">=</span> <span class="n">piv</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Storing your piv results, either with time in place or after applying reducers can also be done. We recommend using
the NetCDF standard as the data model. <em>pyorc</em> also follows the <a class="reference external" href="https://cfconventions.org/">Climate and Forecast conventions</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># store results in a file, this will take a while</span>
<span class="n">piv</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="s2">&quot;piv_results.nc&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Only when you store or otherwise retrieve data resulting from <code class="docutils literal notranslate"><span class="pre">get_piv</span></code>, the computations will actually be performed.
Therefore it is normal that only after calling a command that retrieves data, you will need to wait for a while before
data is returned. This may take several minutes for small problems, but for large areas of interest or large amounts of
time steps (or a slow machine) it can also take half an hour or longer. To keep track of progress you can also first
prepare the storage process and the wrap a <code class="docutils literal notranslate"><span class="pre">ProgressBar</span></code> from the <code class="docutils literal notranslate"><span class="pre">dask.diagnostics</span></code> library.
Below you can find an example how to store data with such a progress bar.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># import ProgressBar</span>
<span class="kn">from</span> <span class="nn">dask.diagnostics</span> <span class="kn">import</span> <span class="n">ProgressBar</span>
<span class="c1"># store results with a progress bar</span>
<span class="n">delayed_obj</span> <span class="o">=</span> <span class="n">piv</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="s2">&quot;piv_results.nc&quot;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">with</span> <span class="n">ProgressBar</span><span class="p">():</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">delayed_obj</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
<p>You should then see a progressing bar on your screen while data is stored. If you wish to load your results into
memory after having stored it in a previous session, you can simply use <code class="docutils literal notranslate"><span class="pre">xarray</span></code> functionality to do so.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="n">piv</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s2">&quot;piv_results.nc&quot;</span><span class="p">)</span>
<span class="n">piv</span>
</pre></div>
</div>
</section>
<section id="masking-spurious-velocities">
<h2>Masking spurious velocities<a class="headerlink" href="#masking-spurious-velocities" title="Permalink to this heading">#</a></h2>
<p>In many cases, you may find that velocities are not accurately resolved, either consistently in a given location or
region in the area of interest, or in specific time steps for given frame to frame results. Nevertheless, the
<code class="docutils literal notranslate"><span class="pre">get_piv</span></code> method will return results in those cases, even though these may be incorrect or very inaccurate. Causes
for such spurious or poorly estimated velocities may be:</p>
<ul class="simple">
<li><p>very little visible patterns available to trace: this can cause many moments in time in which no velocities are
observed. If only sometimes a traceable pattern passes by, longer integration time may be needed, e.g. 30 or 60 seconds.
With low flow velocities (typically 0.5 m/s or lower) longer integration times are often needed to capture enough valid
velocities.</p></li>
<li><p>poor light conditions, e.g. too dark: causes patterns to be difficult to be distinguished. The pre-processing method
<code class="docutils literal notranslate"><span class="pre">pyorc.Frames.edge_detect</span></code> is useful in this case to strengthen gradients in the patterns before estimating velocities.</p></li>
<li><p>very strong visibility of the bottom: causes patterns on the surface to be more difficult to distinguish from non-moving
bottom patterns. In part this can be resolved with the <code class="docutils literal notranslate"><span class="pre">pyorc.Frames.normalize</span></code> method.</p></li>
<li><p>wind: you may find very nice velocity vectors which show a very different process than what you are looking for.
Especially when the wind waves are oriented in the same direction as the flow, this is very difficult to resolve.</p></li>
<li><p>poor quality footage: water is typically a relatively uniform and relatively dark surface. If your footage has a low
bitrate (e.g. 1080p with 2Mbps), then the compression algorithm used will usually decide that the water surface
contains very little interesting information to store. This results in strong loss of visibility of patterns and hence
poor results, usually resulting in underestimation of velocities. Cheap IP cameras are notorious condidates for poor
quality videos and underestimation of velocities and river discharge.</p></li>
</ul>
<p>To accomodate masking out valid velocities from spurious ones, we have developed a subclass <code class="docutils literal notranslate"><span class="pre">pyorc.Velocimetry.mask</span></code>
which contains many masking methods to remove spurious velocities. We refer to the API descriptions on how to apply
each specific masking method, and what parameters may be influenced. Here we provide a general description of how to
apply masks and what to be aware of.</p>
<p>Usually one will use a set of masks, either organized in combination or in cascade, to improve the results. So there
are two ways to apply masks, both can lead to quite different results.</p>
<section id="independent-masks">
<h3>Independent masks<a class="headerlink" href="#independent-masks" title="Permalink to this heading">#</a></h3>
<p>With this approach, you first assemble a set of masks by analyzing your raw results several times independently.
Only after having derived the masks, do you apply them on your data in one go. Below we show a small code example
how that works in the code.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># get a mask to remove values that are based on a too low correlation</span>
<span class="n">mask_corr</span> <span class="o">=</span> <span class="n">piv</span><span class="o">.</span><span class="n">velocimetry</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">tolerance</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="c1"># get a mask to remove velocities that are lower or higher than a user defined threshold (default 0.1 and 5 m s-1)</span>
<span class="n">mask_minmax</span> <span class="o">=</span> <span class="n">piv</span><span class="o">.</span><span class="n">velocimetry</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">minmax</span><span class="p">()</span>
<span class="c1"># get a mask for outliers, that deviate a lot from the mean, measured in standard deviations in time</span>
<span class="n">mask_outliers</span> <span class="o">=</span> <span class="n">piv</span><span class="o">.</span><span class="n">velocimetry</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">outliers</span><span class="p">()</span>
<span class="c1"># count per grid cell, how many valid (i.e. non masked) values we have, only when there this is above 50% do we trust</span>
<span class="c1"># the results</span>
<span class="n">mask_count</span> <span class="o">=</span> <span class="n">ds_mask</span><span class="o">.</span><span class="n">velocimetry</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">tolerance</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="c1"># now apply the resulting masks</span>
<span class="n">piv_masked</span> <span class="o">=</span> <span class="n">piv</span><span class="o">.</span><span class="n">velocimetry</span><span class="o">.</span><span class="n">mask</span><span class="p">([</span>
    <span class="n">mask_corr</span><span class="p">,</span>
    <span class="n">mask_minmax</span><span class="p">,</span>
    <span class="n">mask_outliers</span><span class="p">,</span>
    <span class="n">mask_count</span>
<span class="p">])</span>
</pre></div>
</div>
<p>It is easy to understand that here the order in which we derive the masks will not matter. This is because we only
apply the masks at the very end. Following this approach the last mask we derive will not do anything, because the
variable <code class="docutils literal notranslate"><span class="pre">mask_count</span></code> is basically derived from the raw results, which are not likely to contain any masked out values
yet. Hence in many cases it may make sense to first apply a set of masks, for instance those that work on individual
values rather than using a full analysis in time, or a neighbourhood analysis of neighbouring grid cells, and only after
that apply other masks that use counts of valid values, check how well neighbouring values match the value under
consideration or compute standard deviations or variance in time to evaluate how valid a velocity may be.</p>
</section>
<section id="conditional-masking-by-cascading-masks">
<h3>Conditional masking by cascading masks<a class="headerlink" href="#conditional-masking-by-cascading-masks" title="Permalink to this heading">#</a></h3>
<p>Therefore, we recommend to consider using cascades of masks, so that already applied masks influence the result of
later applied masks for which an analysis of the values through time is essential. For instance, <code class="docutils literal notranslate"><span class="pre">mask.outlier</span></code>
checks for each grid cell what the mean and standard deviation of velocities through time is, and then assesses
which velocity values are above or under a certain amount of standard deviations. If this mask method is applied before any
of the masks that work on individual values, of the outliers that may have been removed with those masks will
influence the results of this mask, making it less effective. Cascading can be done, by either deriving a few masks, applying
them, and then deriving more masks using the results of the first masking, or simply by using the <code class="docutils literal notranslate"><span class="pre">inplace=True</span></code> flag
which immediate overwrites the velocity vectors with missings where the mask is indicating so. Below we show how that
works.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># directly apply a mask to remove values that are based on a too low correlation</span>
<span class="n">piv</span><span class="o">.</span><span class="n">velocimetry</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">tolerance</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># directly apply a mask to remove velocities that are lower or higher than a user defined threshold (default 0.1 and 5 m s-1)</span>
<span class="n">piv</span><span class="o">.</span><span class="n">velocimetry</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">minmax</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># directly apply a mask for outliers, that deviate a lot from the mean, measured in standard deviations in time</span>
 <span class="n">piv</span><span class="o">.</span><span class="n">velocimetry</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">outliers</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># directly apply another mask that remove grid cells entirely when their variance is deemed too high to be trustworthy</span>
<span class="n">piv</span><span class="o">.</span><span class="n">velocimetry</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">variance</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># count per grid cell, how many valid (i.e. non masked) values we have, only when there this is above 50% do we trust</span>
<span class="c1"># the results</span>
<span class="n">piv</span><span class="o">.</span><span class="n">velocimetry</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">tolerance</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case, as masks are already applied before <code class="docutils literal notranslate"><span class="pre">mask.count</span></code> is called, <code class="docutils literal notranslate"><span class="pre">mask.count</span></code> will have effect!
In our experience cascading of masks leads to much better results than independently combined masks.</p>
<p>Some masks may also be applied on time averaged data.</p>
</section>
<section id="some-specific-masks">
<h3>Some specific masks<a class="headerlink" href="#some-specific-masks" title="Permalink to this heading">#</a></h3>
<p>A few masks are worthwhile to mention specifically, as they may lead to unexpected results if you don’t know how they
work.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">mask.angle</span></code>: this mask removes velocities that do not follow an expected flow direction. The default for this
is left-to right oriented flow in the orthorectified x, y grid, with a tolerance of 0.5 * pi (i.e. 90 degrees).
This means that if flow in your x, y grid is oriented from bottom to top, almost all your velocities will be removed
and your filtered result will be empty. In streams with a very clear dominant flow direction however, this filter is
very useful. To ensure your flow follows a left-to-right direction, the selection of corner points in your camera
configuration is important. If you select these in the right order, the orientation will be correct. The right order
should be:</p>
<ul class="simple">
<li><p>upstream left bank</p></li>
<li><p>downstream left bank</p></li>
<li><p>downstream right bank</p></li>
<li><p>upstream right bank</p></li>
</ul>
<p>The angle masking method can then be applied as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mask_angle</span> <span class="o">=</span> <span class="n">piv</span><span class="o">.</span><span class="n">velocimetry</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">angle</span><span class="p">()</span> <span class="c1"># add inplace=True if you want to apply directly</span>
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">mask.window_median</span></code>: this mask can only be applied on time-reduced results and analyses (instead of time series) values
of neighbours in a certain window defined by parameter <code class="docutils literal notranslate"><span class="pre">wdw</span></code>. <code class="docutils literal notranslate"><span class="pre">wdw=1</span></code> means that a one left/right/above/under
window is analyzed resulting in a 3x3 window. If the velocity in the cell under consideration is very different
from the mean of its surrounding cells (defined by <code class="docutils literal notranslate"><span class="pre">tolerance</span></code> and measured as a relative velocity to the mean)
the value is removed. Windows can also be defined with specific strides in x and y direction. See <a class="reference internal" href="../api.html#api"><span class="std std-ref">API reference</span></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mask.window_nan</span></code>: this mask can only be applied on time-reduced results and analyses (instead of time series) values
of neighbours in a certain window defined by parameter <code class="docutils literal notranslate"><span class="pre">wdw</span></code>. If there are too many missings in the window, then the value considered
is also removed. This is meant to remove isolated values.</p></li>
</ul>
</section>
</section>
<section id="plotting">
<h2>Plotting<a class="headerlink" href="#plotting" title="Permalink to this heading">#</a></h2>
<p>Another subclass is available for very easy and convenient plotting of results under <code class="docutils literal notranslate"><span class="pre">pyorc.Velocimetry.plot</span></code>.
The plotting methods so far are only geospatial of nature (i.e. no time series) and therefore require that you first
reduce any time variable results over time, for instance with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># assume that processed and masked results are in piv</span>
<span class="n">piv_mean</span> <span class="o">=</span> <span class="n">piv</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">keep_attrs=True</span></code> flag is quite important here as we may need the attributes to reproject data from the default
x, y projection to the original camera perspective for instance.</p>
</div>
<p>After reducing, we can use a set of methods to make plots, in a very similar manner as used for plotting
<a class="reference internal" href="frames/index.html#frames-man"><span class="std std-ref">Frames</span></a>. In fact, you can smartly combine plots from a frame, with plots of your velocimetry results and by
doing so create beautiful augmented reality views, or geospatial views. The different plotting method all use an
underlying <code class="docutils literal notranslate"><span class="pre">matplotlib.pyplot</span></code> function and are also named accordingly. Hence they can receive keyword arguments
specific to these underlying functions. In addition, a few additional important keywords can be added:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">add_colorbar=True</span></code>: this flag will add a default colorbar to the axes</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mode</span></code>: this flag can be set to <code class="docutils literal notranslate"><span class="pre">local</span></code> (default), <code class="docutils literal notranslate"><span class="pre">geographical</span></code> (for plots in a geospatial view) and
<code class="docutils literal notranslate"><span class="pre">camera</span></code> for augmented reality in the camera’s original perspective.</p></li>
</ul>
<p>Each plotting method always returns the mappable so that you can make your own colorbars, and refer to its parent axes
and in turn the axes parent figure.</p>
<p>The different plotting methods are summarised below.</p>
<table class="table">
<colgroup>
<col style="width: 33%" />
<col style="width: 40%" />
<col style="width: 27%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Plot function</p></th>
<th class="head" colspan="2"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">pyorc.Velocimetry.plot.pcolormesh</span></code></p></td>
<td colspan="2"><p>computes scalar velocities and plots these as a gridded mesh</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">pyorc.Velocimtry.plot.scatter</span></code></p></td>
<td colspan="2"><p>computes scalar velocities and plots as colored dots</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">pyorc.Velocimetry.plot.streamplot</span></code></p></td>
<td colspan="2"><p>draws a streamplot through the x and y-directional velocities. Only works with
<code class="docutils literal notranslate"><span class="pre">mode=&quot;local&quot;</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">pyorc.Velocimetry.plot.quiver</span></code></p></td>
<td colspan="2"><p>draws a quiver plot using the x and y-directional velocities. If
<code class="docutils literal notranslate"><span class="pre">pyorc.Velocimetry.plot</span></code> is called directly, this method is used</p></td>
</tr>
</tbody>
</table>
<p>Assuming you have rgb frames in an object called <code class="docutils literal notranslate"><span class="pre">frames_rgb</span></code> and your mean-in-time piv results in <code class="docutils literal notranslate"><span class="pre">piv_mean</span></code>, a very nice
augmented reality view can be drawn as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># use Normalize to create a scale for quiver (matplotlib.pyplot.quiver does not accept vmin or vmax)</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">Normalize</span>

<span class="n">plot</span> <span class="n">the</span> <span class="n">first</span> <span class="n">frame</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">da_rgb_proj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="c1">#...and then plot the filtered velocimetry (quiver is default) on top of the axes of mappable p</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">piv_mean</span><span class="o">.</span><span class="n">velocimetry</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;rainbow&quot;</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mf">0.0015</span><span class="p">,</span>
    <span class="n">norm</span><span class="o">=</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmax</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># store the parent figure object to a file</span>
<span class="n">p</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;piv_result.jpg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/example_geul_small.jpg" src="../_images/example_geul_small.jpg" />
</section>
</section>


            </article>
            
            
            
            <footer class="bd-footer-article">
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
  <a class='left-prev' id="prev-link" href="frames/frames.html" title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
          <p class="prev-next-subtitle">previous</p>
          <p class="prev-next-title">Frames</p>
      </div>
  </a>
  <a class='right-next' id="next-link" href="transect.html" title="next page">
  <div class="prev-next-info">
      <p class="prev-next-subtitle">next</p>
      <p class="prev-next-title">Transect</p>
  </div>
  <i class="fa-solid fa-angle-right"></i>
  </a>
</div>
            </footer>
            
          </div>
          
          
          
            <div class="bd-sidebar-secondary bd-toc">
              
<div class="toc-item">
  
<div class="tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
</div>
<nav id="bd-toc-nav" class="page-toc">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#particle-image-velocimetry">
   Particle Image Velocimetry
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#interrogating-and-storing-piv-results">
   Interrogating and storing PIV results
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#masking-spurious-velocities">
   Masking spurious velocities
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#independent-masks">
     Independent masks
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#conditional-masking-by-cascading-masks">
     Conditional masking by cascading masks
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#some-specific-masks">
     Some specific masks
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plotting">
   Plotting
  </a>
 </li>
</ul>

</nav>
</div>

<div class="toc-item">
  
<div id="searchbox"></div>
</div>

<div class="toc-item">
  
</div>

<div class="toc-item">
  
<div class="tocsection sourcelink">
    <a href="../_sources/user-guide/velocimetry.rst.txt">
        <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
</div>

</div>

            </div>
          
          
        </div>
        <footer class="bd-footer-content">
          <div class="bd-footer-content__inner">
            
          </div>
        </footer>
        
      </main>
    </div>
  </div>

  
    
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94"></script>

  <footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    
<p class="copyright">

    &copy; Copyright 2022, Rainbow Sensing.<br>

</p>

  </div>
  
  <div class="footer-item">
    <p class="theme-version">
    Built with the
    <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">
        PyData Sphinx Theme
    </a>
    0.12.0.
</p>
  </div>
  
  <div class="footer-item">
    
<p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.3.0.<br>
</p>

  </div>
  
</div>
  </footer>
  </body>
</html>